<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>young1337</title>
  <link href="https://fonts.googleapis.com/css2?family=Rock+Salt&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#121212;--panel:#181b24;--panel2:#23272e;--ink:#eee;--muted:#aaa;--line:#292c36;
      --brand:#3fa7ff;--ok:#3fcf7f;--err:#e74c3c;--warn:#c2a176;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Ubuntu,'Helvetica Neue',Arial,'Noto Sans',sans-serif;background:var(--bg);color:var(--ink)}
    header{
  position:fixed;inset:0 0 auto 0;height:54px;background:rgba(18,18,18,.9);
  display:flex;align-items:center;gap:16px;padding:0 18px;z-index:1000;box-shadow:0 2px 8px rgba(0,0,0,.7);
  overflow:visible;
    }
    .logo{
  font-family:'Rock Salt',cursive;
  font-size:3.2rem;
  margin-top:2px;
  color:#fff;
  user-select:none;
  text-shadow:1px 1px 0 #000, 2px 2px 3px rgba(0,0,0,.6);
  margin-right:12px;
  line-height:1.1;
  position:relative;
  top:2px;
    }
    .header-nav{display:flex;align-items:center;gap:18px}
    .app-button{
      font:700 1.1rem 'Segoe UI',Roboto,sans-serif;
      color:#fff;
      background:transparent;
      border:none;
      padding:0 16px;
      border-radius:10px;
      cursor:pointer;
      display:flex;align-items:center;justify-content:center;
      height:36px;
      min-width: 0;
      transition:all .25s cubic-bezier(.4,2,.3,1);
      position:relative;
      overflow:visible;
      line-height:1.1;
      text-shadow:0 2px 12px rgba(80,180,255,.18), 0 0 2px #222;
      margin-top:0;
      margin-bottom:0;
      z-index:2;
    }
    .app-button:hover{
      background:rgba(255,255,255,.12);
      border:2px solid rgba(255,255,255,.22);
      box-shadow:0 4px 24px rgba(80,180,255,.18), 0 0 0 2px rgba(80,180,255,.12) inset;
      backdrop-filter:blur(12px) saturate(140%) brightness(1.12) contrast(1.08);
    }
    .app-button::after {
      content:"";
      position:absolute;
      left:0;top:0;right:0;bottom:0;
      pointer-events:none;
      opacity:0;
      transition:opacity .3s;
      background:radial-gradient(circle at 60% 40%,rgba(255,255,255,.18) 0%,rgba(255,255,255,0) 70%);
      z-index:1;
    }
    .app-button:hover::after {
      opacity:.8;
    }
    .app-button.disabled{color:#888;cursor:default}
    main{padding-top:80px;text-align:center}
    .hidden{display:none !important}

    /* --- Универсальная модалка (серый дизайн) --- */
    .modal{display:none;position:fixed;inset:0;z-index:2000;background:rgba(0,0,0,.7);justify-content:center;align-items:center}
    .modal-content-gray{
      background:var(--panel2);border-radius:14px;padding:28px 24px;min-width:340px;max-width:500px;color:var(--ink);text-align:center;position:relative
    }
    .close-btn{position:absolute;right:12px;top:10px;font-size:1.6rem;color:#aaa;background:none;border:none;cursor:pointer}
    .close-btn:hover{color:#fff}
    .input-gray{
      width:100%;margin-bottom:12px;padding:12px;border-radius:9px;border:1.5px solid #444;background:#2e323a;color:#fff;outline:none
    }
    .input-gray:focus{border-color:#666;background:#353942}
    .modal-main-btn{
      width:100%;background:transparent;color:#fff;border-radius:8px;margin-top:8px;font-size:1.05rem;font-weight:600;padding:12px 0;border:none
    }
    .modal-main-btn:hover{background:rgba(128,128,128,.2)}

    /* --- Профиль --- */
    .profile-avatar{width:84px;height:84px;border-radius:50%;object-fit:cover;background:#1e1e1e;border:2px solid var(--brand);display:block;margin:6px auto 10px}
    .center-btn { display: flex; justify-content: center; margin-bottom: 8px; }
    .edit-nick-btn {
      background:transparent;
      border:none;
      color:var(--brand);
      font-size:1.2em;
      cursor:pointer;
      margin-left:6px;
      vertical-align:middle;
      transition:color .2s;
    }
    .edit-nick-btn:hover { color:#fff; }
    .hashtag-input {
      max-width:60px;
      margin-right:8px;
      text-align:center;
      font-weight:700;
      font-size:1.05em;
      border-radius:8px;
      border:1px solid #444;
      background:#23272e;
      color:#3fa7ff;
      padding:8px 6px;
    }
    .profile-pass-row {
      display: flex;
      gap: 0;
      margin-bottom: 8px;
    }
    #newPasswordInput {
      flex: 1;
      border-top-right-radius: 0;
      border-bottom-right-radius: 0;
      margin-bottom: 0;
      border-right: none;
    }
    #changePasswordBtn {
      border-top-left-radius: 0;
      border-bottom-left-radius: 0;
      margin-bottom: 0;
      height: 48px;
      font-size: 1.08em;
      padding: 0 18px;
      min-width: 120px;
    }

    /* --- Чат-панель --- */
    #chatPanel{display:none;position:fixed;inset:0;z-index:1500;background:rgba(0,0,0,.45);align-items:flex-start;justify-content:center}
    .chat-window{
      display:flex;gap:0;background:#222;border-radius:12px;max-width:1100px;width:95vw;height:80vh;margin-top:64px;overflow:hidden;position:relative;box-shadow:0 4px 32px rgba(0,0,0,.7)
    }
    .chat-left{
      width:280px;min-width:220px;max-height:100%;overflow-y:auto;background:var(--panel);border-right:1px solid var(--line);display:flex;flex-direction:column
    }
    .chat-left-header{padding:16px 16px 8px 16px;font-weight:700;color:#ddd}
    .chat-add-btn{
      margin:0 12px 12px 12px;display:flex;align-items:center;gap:8px;padding:10px 12px;border-radius:8px;background:var(--panel2);color:#fff;cursor:pointer;font-weight:700;justify-content:center;border:1px solid transparent
    }
    .chat-add-btn:hover{border-color:#445}
    .chat-list{display:flex;flex-direction:column;padding:4px 8px 12px 8px;gap:6px}
    .chat-item{
      display:flex;align-items:center;gap:10px;padding:10px;border-radius:10px;background:transparent;color:#ddd;cursor:pointer;border:1px solid transparent
    }
    .chat-item:hover{background:#212630;border-color:#2a3344}
    .chat-item.selected{background:#23272e;border-color:#334;box-shadow:inset 0 0 0 1px #334}
    .chat-item-avatar{width:38px;height:38px;border-radius:50%;object-fit:cover;background:#1e1e1e;border:1px solid #333}
    .chat-item-txt{display:flex;flex-direction:column;min-width:0}
    .chat-item-nick{color:var(--brand);font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .chat-item-last{color:#aaa;font-size:.92em;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    .chat-main{flex:1;display:flex;flex-direction:column;min-width:0}
    .chat-header{padding:12px 14px;border-bottom:1px solid var(--line);display:flex;align-items:center;gap:10px;background:#1c1f27}
    .chat-peer-avatar{width:40px;height:40px;border-radius:50%;border:1px solid #333;object-fit:cover}
    .chat-peer-avatar.empty { display:none; }
    .chat-peer-name{font-weight:800;color:#fff}
    .chat-msgs{flex:1;overflow-y:auto;padding:10px;background:transparent}
    .msg-row{display:flex;align-items:flex-start;gap:10px;padding:6px 8px;border-bottom:1px solid #333}
    .msg-avatar{width:36px;height:36px;border-radius:50%;object-fit:cover;background:#1e1e1e;border:1px solid #333}
    .msg-head{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .msg-nick{color:var(--brand);font-weight:800}
    .chat-role-badge{font-size:.83em;background:#333950;color:#5cb7ff;border-radius:8px;padding:1px 9px;font-weight:700}
    .chat-role-admin{background:#2d1e36;color:#ff7d7d}.chat-role-moder{background:#2d2a1e;color:#ffe27d}.chat-role-user{background:#22332d;color:#3fcf7f}.chat-role-govnar{background:#3b2414;color:#c2a176}
    .msg-time{color:#888;font-size:.9em}
    .msg-text{color:#fff;margin-top:3px;white-space:pre-wrap;word-break:break-word}
    .msg-actions{margin-left:auto;display:flex;gap:4px}
    .icon-btn{background:transparent;border:none;color:#bbb;font-size:1.05rem;cursor:pointer;border-radius:6px;padding:4px 6px}
    .icon-btn:hover{background:#2a3344;color:#fff}
    .msg-edited{color:#888;font-size:.92em;margin-left:6px;font-style:italic}
    .msg-deleted{color:#999;font-style:italic}

    .chat-input-row{display:flex;gap:10px;padding:12px;border-top:1px solid var(--line)}
    #chatInput{flex:1;padding:12px;border-radius:8px;border:1px solid #555;background:#333;color:#eee}
    #chatSend{padding:10px 16px}

    /* Выбор пользователя для нового чата */
    .userpick-list{max-height:420px;overflow:auto;border-top:1px solid #333;margin-top:10px;padding-top:8px}
    .userpick-item{display:flex;align-items:center;gap:10px;padding:8px;border-radius:8px;cursor:pointer}
    .userpick-item:hover{background:#23272e}
    .userpick-avatar{width:36px;height:36px;border-radius:50%;object-fit:cover;background:#1e1e1e;border:1px solid #333}
    .toast{position:fixed;left:50%;transform:translateX(-50%);top:22px;z-index:4000;background:#23272e;color:#fff;padding:12px 18px;border-radius:10px;opacity:0;pointer-events:none;transition:opacity .25s, top .25s}
    .toast.show{opacity:1;top:40px}

    /* Кнопка закрытия чата */
    #closeChatBtn{position:absolute;right:12px;top:8px}
  </style>
</head>
<body>
<header>
  <div class="logo">young1337</div>
  <nav class="header-nav">
  <!-- Liquid Glass Auth Modal Styles -->
  <style>
    .container {
      background: rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(20px) saturate(150%);
      -webkit-backdrop-filter: blur(20px) saturate(150%);
      border-radius: 20px;
      padding: 40px;
      width: 600px;
      box-shadow: 0 0 25px rgba(0,0,0,0.6), inset 0 0 0 1px rgba(255,255,255,0.15);
      color: white;
      position:relative;
    }
    .tabs {
      display: flex;
      position: relative;
      margin-bottom: 30px;
      background: rgba(255,255,255,0.05);
      border-radius: 12px;
      overflow: hidden;
    }
    .tab {
      flex: 1;
      text-align: center;
      padding: 15px 0;
      cursor: pointer;
      font-size: 1.2em;
      color: rgba(255,255,255,0.7);
      transition: color 0.3s ease;
      position: relative;
      z-index: 1;
    }
    .tab.active { color: #fff; }
    .indicator {
      position: absolute;
      height: 100%;
      width: 50%;
      top: 0;
      left: 0;
      background: rgba(255, 255, 255, 0.12);
      backdrop-filter: blur(15px);
      -webkit-backdrop-filter: blur(15px);
      border-radius: 12px;
      box-shadow: inset 0 0 25px rgba(255,255,255,0.3), inset 0 0 10px rgba(255,255,255,0.5);
      transition: left 0.4s ease;
    }
    .form {
      display: none;
      flex-direction: column;
      gap: 20px;
      opacity: 0;
      transform: translateY(10px);
      transition: all 0.4s ease;
    }
    .form.active {
      display: flex;
      opacity: 1;
      transform: translateY(0);
    }
    #authModal input {
      padding: 15px;
      font-size: 1.1em;
      border-radius: 10px;
      border: none;
      background: rgba(255,255,255,0.12);
      backdrop-filter: blur(5px);
      color: white;
      outline: none;
      box-shadow: inset 0 0 10px rgba(255,255,255,0.2);
    }
    #authModal input::placeholder { color: rgba(255,255,255,0.6); }
    #authModal button {
      padding: 15px;
      font-size: 1.1em;
      border: none;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      color: white;
      font-weight: bold;
      cursor: pointer;
      position: relative;
      overflow: hidden;
      box-shadow: inset 0 0 15px rgba(255,255,255,0.25), 0 4px 20px rgba(0,0,0,0.4);
      transition: transform 0.2s ease, box-shadow 0.3s ease;
    }
    #authModal button::before {
      content: "";
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle at center, rgba(255,255,255,0.5) 0%, transparent 70%);
      opacity: 0.2;
      transform: translate(-50%, -50%) rotate(0deg);
      transition: transform 0.5s ease;
    }
    #authModal button:hover::before { transform: translate(-50%, -50%) rotate(25deg); }
    #authModal button:hover {
      transform: scale(1.03);
      box-shadow: inset 0 0 20px rgba(255,255,255,0.35), 0 6px 25px rgba(0,0,0,0.5);
    }
  </style>
    <button class="app-button" id="openProfile" style="display:none;">Профиль</button>
  <button class="app-button" id="openAuth">Авторизация</button>
    <button class="app-button" id="openChat">Чаты</button>
    <button class="app-button" id="openNews">Новости</button>
  </nav>
</header>

<main id="mainContent">
  <h1>Привет!</h1>
</main>

<!-- AUTH MODAL (Liquid Glass) -->
<div id="authModal" class="modal" style="z-index:3000;">
  <div class="container">
    <div class="tabs">
      <div class="indicator"></div>
      <div class="tab active" data-tab="login">Вход</div>
      <div class="tab" data-tab="register">Регистрация</div>
    </div>
    <form class="form active" id="login">
      <input type="email" id="loginEmail" placeholder="Email" required>
      <input type="password" id="loginPassword" placeholder="Пароль" required>
      <button type="submit" id="loginSubmit">Войти</button>
    </form>
    <form class="form" id="register">
      <input type="email" id="registerEmail" placeholder="Email" required>
      <input type="password" id="registerPassword" placeholder="Пароль" required>
      <button type="submit" id="registerSubmit">Зарегистрироваться</button>
    </form>
  <button class="close-btn" id="closeAuth" style="position:absolute;right:18px;top:18px;font-size:1.1rem;background:none;border:none;cursor:pointer;">×</button>
  </div>
</div>
<!-- PROFILE -->
<div id="profileModal" class="modal">
  <div class="modal-content-gray" style="max-width:480px">
    <button class="close-btn" id="closeProfile">×</button>
    <img id="profileAvatar" class="profile-avatar" src="" alt="avatar">
    <div class="center-btn">
      <button id="changeAvatarBtn" class="app-button" style="margin-bottom:0;">Сменить аватар</button>
    </div>
    <div style="margin:8px 0">
      <input id="hashtagInput" class="hashtag-input" maxlength="4" placeholder="#tag">
      <span id="profileNickname" style="font-weight:800"></span>
      <button id="editNickBtn" class="edit-nick-btn" title="Сменить ник">✏️</button>
      <span id="profileRoleBadge" class="role-label">Пользователь</span>
    </div>
    <div style="margin:6px 0">Почта: <span id="profileEmail"></span></div>
    <div style="margin:6px 0">
      <input id="changeAvatarInput" type="file" accept="image/*" style="display:none" />
      <!-- Смена пароля -->
      <div class="profile-pass-row">
        <input id="newPasswordInput" class="input-gray" type="password" placeholder="Новый пароль">
        <button id="changePasswordBtn" class="app-button">Сменить пароль</button>
      </div>
    </div>
    <button id="logoutBtn" class="modal-main-btn" style="margin-top:10px;background:#e74c3c">Выйти</button>
  </div>
</div>

<!-- Модалка смены ника -->
<div id="nickModal" class="modal">
  <div class="modal-content-gray" style="max-width:340px">
    <button class="close-btn" id="closeNickModal">×</button>
    <h2>Сменить ник</h2>
    <input id="nicknameInput" class="input-gray" placeholder="Новый никнейм">
    <button id="saveNicknameBtn" class="modal-main-btn">Сохранить</button>
  </div>
</div>

<!-- CHAT PANEL -->
<div id="chatPanel" class="modal" style="background:rgba(0,0,0,.45)">
  <div class="chat-window">
    <button id="closeChatBtn" class="close-btn" title="Закрыть">×</button>
    <aside class="chat-left">
      <div class="chat-left-header">Чаты</div>
      <button id="addChatBtn" class="chat-add-btn">+</button>
      <div id="chatList" class="chat-list"></div>
    </aside>
    <section class="chat-main">
      <div class="chat-header">
        <img id="peerAvatar" class="chat-peer-avatar empty" src="" alt="">
        <div class="chat-peer-name" id="peerName">Выберите чат</div>
      </div>
      <div id="chatMessages" class="chat-msgs"></div>
      <div class="chat-input-row">
        <input id="chatInput" type="text" placeholder="Ваше сообщение...">
        <button id="chatSend" class="app-button">Отправить</button>
      </div>
    </section>
  </div>
</div>

<!-- USER PICKER -->
<div id="userPickerModal" class="modal">
  <div class="modal-content-gray" style="max-width:520px">
    <button class="close-btn" id="closeUserPicker">×</button>
    <h2>Начать новый чат</h2>
    <input id="userSearch" class="input-gray" placeholder="Поиск по нику или email">
    <div id="userPickerList" class="userpick-list"></div>
  </div>
</div>

<!-- NEWS -->
<div id="newsModal" class="modal">
  <div class="modal-content-gray">
    <button class="close-btn" id="closeNews">×</button>
    <h2>Новости</h2>
    <div style="text-align:left">
      <ul>
        <li>2.0 Update -14-08-2025- Обновление!, добавлены новые приватные чаты, новый дизайн
          в стиле Liquid Glass, новая авторизация, оптимизация скорости, новый профиль, #теги
          Система чатов после хостинга может работать не корректно. Если сообщения не отправляються
          после самого первого, не пугайтесь, это временно, Firebase до сих пор шалит.
        </li>
      </ul>
    </div>
  </div>
</div>

<!-- SHORTS (упрощённый рендер) -->
<div id="shortsModal" class="modal">
  <div class="modal-content-gray" style="max-width:420px">
    <button class="close-btn" id="closeShorts">×</button>
    <h2>1337Shorts</h2>
    <div id="shortsList" style="max-height:55vh;overflow:auto;text-align:left"></div>
    <hr style="border-color:#333">
    <input id="shortsDesc" class="input-gray" placeholder="Описание (до 80 символов)" maxlength="80">
    <input id="shortsFile" type="file" accept="video/*" />
    <button id="shortsPublish" class="modal-main-btn">Опубликовать</button>
  </div>
</div>

<div id="toast" class="toast"></div>

<script type="module">
/* ======================== Firebase ======================== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
import { getDatabase, ref, push, onValue, off, remove, set, update, get, child, query, limitToLast, orderByChild } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyDjTaleNo3RlfJECEEm24UGg4sx6AFvp7E",
  authDomain: "young1337-c6a15.firebaseapp.com",
  databaseURL: "https://young1337-c6a15-default-rtdb.firebaseio.com",
  projectId: "young1337-c6a15",
  storageBucket: "young1337-c6a15.appspot.com",
  messagingSenderId: "349710701737",
  appId: "1:349710701737:web:c9f5e5e86d0b29dc6b05b8",
  measurementId: "G-DXVL8D5L44"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);
const storage = getStorage(app);

/* ======================== Utils ======================== */
const ADMIN_EMAIL = "timurnazaev001@gmail.com";
const ROLE_LABELS = { admin:"Разработчик", user:"Пользователь" };
const ROLE_CLASS = { admin:"chat-role-badge chat-role-admin", user:"chat-role-badge chat-role-user" };
const $ = sel => document.querySelector(sel);
const $$ = sel => document.querySelectorAll(sel);
const toast = $('#toast');

function showToast(msg, type='info'){
  toast.textContent = msg;
  toast.style.background = type==='error' ? '#2e2323' : type==='success' ? '#23272e' : '#23272e';
  toast.style.color = type==='error' ? '#f66' : type==='success' ? '#3fcf7f' : '#fff';
  toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'), 2200);
}
function escapeHtml(s){ return (s??'').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;') }
function fmtTime(ts){ const d=new Date(ts); return d.toLocaleString('ru-RU',{hour:'2-digit',minute:'2-digit',day:'2-digit',month:'2-digit'}) }
function avatarOf(nick){ return "https://ui-avatars.com/api/?name="+encodeURIComponent(nick||'?')+"&background=323a47&color=3fa7ff" }
function chatIdOf(a,b){ return [a,b].sort().join('_') }
function preview(text, n=40){ if(!text) return ""; const t=text.replace(/\s+/g,' ').trim(); return t.length>n? t.slice(0,n-1)+'…':t }

/* ======================== DOM refs ======================== */
const openProfileBtn = $('#openProfile');
const openAuthBtn    = $('#openAuth');
const openChatBtn    = $('#openChat');
const openNewsBtn    = $('#openNews');

const authModal = $('#authModal');
const closeAuth = $('#closeAuth');
const profileModal = $('#profileModal'); const closeProfile = $('#closeProfile');
const newsModal = $('#newsModal'); const closeNews = $('#closeNews');

const userPickerModal = $('#userPickerModal'); const closeUserPicker = $('#closeUserPicker');
const userSearch = $('#userSearch'); const userPickerList = $('#userPickerList');

const chatPanel = $('#chatPanel'); const chatList = $('#chatList');
const addChatBtn = $('#addChatBtn'); const chatMessages = $('#chatMessages');
const chatInput = $('#chatInput'); const chatSend = $('#chatSend');
const peerName = $('#peerName'); const peerAvatar = $('#peerAvatar');

const profileEmail = $('#profileEmail'); const profileNickname = $('#profileNickname');
const profileRoleBadge = $('#profileRoleBadge'); const profileAvatar = $('#profileAvatar');
const hashtagInput = $('#hashtagInput');
const editNickBtn = $('#editNickBtn');
const nickModal = $('#nickModal'); const closeNickModal = $('#closeNickModal');
const nicknameInput = $('#nicknameInput'); const saveNicknameBtn = $('#saveNicknameBtn');
const changeAvatarBtn = $('#changeAvatarBtn'); const changeAvatarInput = $('#changeAvatarInput');
const logoutBtn = $('#logoutBtn');
const newPasswordInput = $('#newPasswordInput'); const changePasswordBtn = $('#changePasswordBtn');
/* ======================== State ======================== */
let curUser = null;
let curUserData = {nickname:"", avatar:"", role:"user", email:""};
let usersCache = {};     // uid -> {nickname, avatar, email, role}
let chatsUnsub = null;   // listener for chat messages
let currentPeerUid = null;
let currentChatId = null;

/* ======================== UI helpers ======================== */
function showModal(el){ el.style.display='flex' }
function hideModal(el){ el.style.display='none' }

function setAuthUI(authenticated){
  if(authenticated){
    openProfileBtn.style.display=''; openAuthBtn.style.display='none';
  }else{
    openProfileBtn.style.display='none'; openAuthBtn.style.display='';
  }
}

/* ======================== Auth ======================== */

document.getElementById('register').addEventListener('submit', async e => {
  e.preventDefault();
  const email = document.getElementById('registerEmail').value.trim();
  const pass = document.getElementById('registerPassword').value.trim();
  if(!email || !pass) return showToast('Заполните все поля', 'error');
  try{
    const cred = await createUserWithEmailAndPassword(auth, email, pass);
    const nick = email.split('@')[0];
    const role = email===ADMIN_EMAIL ? 'admin' : 'user';
    await set(ref(db, 'users/'+cred.user.uid), { email, nickname:nick, avatar:'', role });
    showToast('Успешная регистрация', 'success'); hideModal(authModal);
  }catch(e){ showToast('Ошибка: '+e.message, 'error') }
});

document.getElementById('login').addEventListener('submit', async e => {
  e.preventDefault();
  const email = document.getElementById('loginEmail').value.trim();
  const pass = document.getElementById('loginPassword').value.trim();
  if(!email || !pass) return showToast('Заполните все поля', 'error');
  try{
    await signInWithEmailAndPassword(auth, email, pass);
    hideModal(authModal); showToast('Вход выполнен', 'success');
  }catch(e){ showToast('Ошибка: '+e.message, 'error') }
});

logoutBtn.onclick = ()=> signOut(auth);

/* ======================== Users cache & picker ======================== */
async function refreshUsersCache(){
  const snap = await get(ref(db,'users'));
  usersCache = snap.exists()? snap.val() : {};
}

function openUserPicker(){
  userSearch.value = '';
  renderUserPicker('');
  showModal(userPickerModal);
}
function renderUserPicker(filter){
  const f = (filter||'').toLowerCase();
  userPickerList.innerHTML = '';
  Object.entries(usersCache).forEach(([uid,u])=>{
    if(!curUser || uid===curUser.uid) return;
    const needle = (u.nickname||'')+' '+(u.email||'');
    if(f && !needle.toLowerCase().includes(f)) return;
    const av = u.avatar || avatarOf(u.nickname);
    const el = document.createElement('div');
    el.className = 'userpick-item';
    el.innerHTML = `
      <img class="userpick-avatar" src="${av}" alt="">
      <div style="display:flex;flex-direction:column">
        <div style="font-weight:800;color:#fff">${escapeHtml(u.nickname||'?')}</div>
        <div style="color:#aaa;font-size:.92em">${escapeHtml(u.email||'')}</div>
      </div>
    `;
    el.onclick = ()=>{ hideModal(userPickerModal); openChatWith(uid); };
    userPickerList.appendChild(el);
  });
}
userSearch.addEventListener('input', e=>renderUserPicker(e.target.value));

/* ======================== Chat index (userChats) ========================
   userChats/{uid}/{peerUid} = {
     lastTimestamp, lastMessage, peerNickname, peerAvatar, peerRole
   }
======================================================================= */

function listenChatList(){
  if(!curUser) return;
  onValue(ref(db, 'userChats/'+curUser.uid), snap=>{
    const list = snap.exists()? snap.val() : {};
    const arr = Object.entries(list).map(([peerUid,info])=>({peerUid, ...info}));
    arr.sort((a,b)=>(b.lastTimestamp||0)-(a.lastTimestamp||0));
    renderChatList(arr);
  });
}

function renderChatList(items){
  chatList.innerHTML = '';
  items.forEach(item=>{
    const u = usersCache[item.peerUid] || {};
    const avatar = (item.peerAvatar || u.avatar || avatarOf(u.nickname));
    const selected = item.peerUid===currentPeerUid ? 'selected' : '';
    const li = document.createElement('div');
    li.className = `chat-item ${selected}`;
    li.dataset.uid = item.peerUid;
    li.innerHTML = `
      <img class="chat-item-avatar" src="${avatar}" alt="">
      <div class="chat-item-txt">
        <div class="chat-item-nick">${escapeHtml(u.nickname||'???')}</div>
        <div class="chat-item-last">${escapeHtml(item.lastMessage||'')}</div>
      </div>
      <button class="icon-btn delete-chat-btn" title="Удалить чат" style="margin-left:auto;font-size:1em;padding:2px 6px;" data-uid="${item.peerUid}">🗑️</button>
    `;
    li.querySelector('.delete-chat-btn').onclick = async (e) => {
      e.stopPropagation();
      if (!confirm('Удалить чат полностью для обоих пользователей?')) return;
      await remove(ref(db, `privateChats/${chatIdOf(curUser.uid, item.peerUid)}`));
      await Promise.all([
        remove(ref(db, `userChats/${curUser.uid}/${item.peerUid}`)),
        remove(ref(db, `userChats/${item.peerUid}/${curUser.uid}`))
      ]);
      showToast('Чат удалён', 'success');
      listenChatList();
      chatMessages.innerHTML = '<div style="color:#666;text-align:center;margin-top:16px">Чат удалён.</div>';
    };
    li.onclick = ()=> openChatWith(item.peerUid);
    chatList.appendChild(li);
  });
}

/* ======================== Open chat & messages ======================== */
function openChatPanel(){
  showModal(chatPanel);
  setTimeout(()=>chatInput.focus(), 50);
}
function closeChatPanel(){
  hideModal(chatPanel);
}

async function openChatWith(peerUid){
  if(!curUser) { showToast('Войдите для доступа к чату', 'error'); return; }
  if(chatsUnsub){ off(ref(db,'privateChats/'+currentChatId)); chatsUnsub=null; }
  currentPeerUid = peerUid;
  currentChatId = chatIdOf(curUser.uid, peerUid);

  const u = usersCache[peerUid] || {};
  const av = u.avatar || avatarOf(u.nickname);
  // peerAvatar.src = av;
  // peerAvatar.classList.remove('empty');
  if (u.avatar) {
    peerAvatar.src = av;
    peerAvatar.classList.remove('empty');
  } else {
    peerAvatar.src = '';
    peerAvatar.classList.add('empty');
  }
  peerName.textContent = u.nickname || 'Пользователь';

  chatMessages.innerHTML = '<div style="color:#aaa;text-align:center;margin-top:16px">Загрузка…</div>';

  const r = ref(db, 'privateChats/'+currentChatId);
  onValue(r, snap=>{
    chatMessages.innerHTML = '';
    if(!snap.exists()){
      chatMessages.innerHTML = '<div style="color:#666;text-align:center;margin-top:16px">Сообщений пока нет. Напишите первым!</div>';
      return;
    }
    // рендер по времени
    const msgs = [];
    snap.forEach(ch=>msgs.push({key:ch.key, ...ch.val()}));
    msgs.sort((a,b)=>(a.timestamp||0)-(b.timestamp||0));
    msgs.forEach(m=>renderMessage(m));
    chatMessages.scrollTop = chatMessages.scrollHeight;
  });
  chatsUnsub = true;

  // выделить чат в списке
  $$('.chat-item').forEach(x=>x.classList.toggle('selected', x.dataset.uid===peerUid));

  // Аккуратная шапка чата
  renderChatHeader(u);
}

function getRoleBadge(role){
  const cls = ROLE_CLASS[role] || ROLE_CLASS.user;
  const title = ROLE_LABELS[role] || ROLE_LABELS.user;
  return `<span class="${cls}">${title}</span>`;
}

function renderMessage(m){
  const mine = curUser && m.uid===curUser.uid;
  const container = document.createElement('div');
  container.className = 'msg-row';
  const u = Object.values(usersCache).find(x=>x.email===m.email) || {};
  const hashtag = u.hashtag ? `<span style=\"color:#3fa7ff;font-weight:700;margin-right:4px\">${escapeHtml(u.hashtag)}</span>` : '';
  const nickname = m.nickname || u.nickname || '???';
  const avatar = m.avatar || u.avatar || avatarOf(nickname);
  const role = m.role || u.role || 'user';
  const editedMark = m.edited ? `<span class=\"msg-edited\">(изменено)</span>` : '';
  const textHtml = `<span class=\"msg-text\">${escapeHtml(m.message||'')}</span>`;
  let editBtn = '';
  if(mine) editBtn = `<button class=\"icon-btn\" title=\"Редактировать сообщение\" data-key=\"${m.key}\">✏️</button>`;
  container.innerHTML = `
    <img class=\"msg-avatar\" src=\"${avatar}\" alt=\"\">
    <div style=\"flex:1;min-width:0\">
      <div class=\"msg-head\">
        ${hashtag}<span class=\"msg-nick\">${escapeHtml(nickname)}</span>
        ${getRoleBadge(role)}
        <span class=\"msg-time\">${fmtTime(m.timestamp||Date.now())}</span>
        ${editedMark}
        ${editBtn}
      </div>
      <div class=\"msg-body\" data-key=\"${m.key}\">
        ${textHtml}
      </div>
    </div>
  `;
  chatMessages.appendChild(container);
  // обработчик редактирования
  if(mine) {
    container.querySelector('.icon-btn').onclick = () => startEditMessage(m);
  }
  chatMessages.scrollTop = chatMessages.scrollHeight;
}

// Модалка/инпут для редактирования сообщения
let editMsgModal = null;
function startEditMessage(m) {
  if(editMsgModal) editMsgModal.remove();
  editMsgModal = document.createElement('div');
  editMsgModal.style.position = 'fixed';
  editMsgModal.style.left = '0';
  editMsgModal.style.top = '0';
  editMsgModal.style.width = '100vw';
  editMsgModal.style.height = '100vh';
  editMsgModal.style.background = 'rgba(0,0,0,0.5)';
  editMsgModal.style.display = 'flex';
  editMsgModal.style.alignItems = 'center';
  editMsgModal.style.justifyContent = 'center';
  editMsgModal.style.zIndex = '5000';
  editMsgModal.innerHTML = `<div style='background:#23272e;padding:32px 28px;border-radius:14px;min-width:320px;max-width:90vw;'>
    <h3 style='margin-top:0'>Редактировать сообщение</h3>
    <textarea id='editMsgInput' style='width:100%;height:80px;border-radius:8px;padding:10px;font-size:1.1em;'>${escapeHtml(m.message||'')}</textarea>
    <div style='margin-top:18px;text-align:right;'>
      <button id='editMsgSave' style='padding:10px 22px;border-radius:8px;background:#3fa7ff;color:#fff;font-weight:700;border:none;cursor:pointer;'>Сохранить</button>
      <button id='editMsgCancel' style='padding:10px 22px;border-radius:8px;background:#555;color:#fff;font-weight:700;border:none;cursor:pointer;margin-left:10px;'>Отмена</button>
    </div>
  </div>`;
  document.body.appendChild(editMsgModal);
  document.getElementById('editMsgInput').focus();
  document.getElementById('editMsgSave').onclick = async () => {
    const newText = document.getElementById('editMsgInput').value.trim();
    if(!newText) return showToast('Сообщение не может быть пустым','error');
    await update(ref(db, `privateChats/${currentChatId}/${m.key}`), { message: newText, edited: true });
    editMsgModal.remove();
  };
  document.getElementById('editMsgCancel').onclick = () => editMsgModal.remove();
  editMsgModal.onclick = e => { if(e.target === editMsgModal) editMsgModal.remove(); };
}

// Аккуратная шапка чата
function renderChatHeader(peer) {
  const chatHeader = document.querySelector('.chat-header');
  if (!chatHeader) return;
  chatHeader.innerHTML = `
    <img id="peerAvatar" class="chat-peer-avatar${peer.avatar ? '' : ' empty'}" src="${peer.avatar || ''}" alt="">
    <div class="chat-peer-name" id="peerName">${escapeHtml(peer.nickname || 'Пользователь')}</div>
  `;
}

/* ======================== Profile ======================== */
// Смена ника через модалку
editNickBtn.onclick = ()=>{ nicknameInput.value = profileNickname.textContent; showModal(nickModal); };
closeNickModal.onclick = ()=> hideModal(nickModal);
saveNicknameBtn.onclick = async ()=>{
  if(!curUser) return;
  const nn = nicknameInput.value.trim(); if(!nn) return showToast('Ник пуст','error');
  await update(ref(db, 'users/'+curUser.uid), { nickname: nn });
  profileNickname.textContent = nn;
  await refreshUsersCache();
  showToast('Ник обновлён','success');
  hideModal(nickModal);
};
// Смена пароля (только новый пароль)
changePasswordBtn.onclick = async ()=>{
  if(!curUser) return;
  const newPass = newPasswordInput.value.trim();
  if(!newPass) return showToast('Введите новый пароль','error');
  try{
    const { updatePassword } = await import("https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js");
    await updatePassword(auth.currentUser, newPass);
    showToast('Пароль изменён','success');
    newPasswordInput.value = '';
  }catch(e){ showToast('Ошибка: '+e.message,'error'); }
};
// Смена аватарки
changeAvatarBtn.onclick = ()=> changeAvatarInput.click();
changeAvatarInput.onchange = async (e)=>{
  if(!curUser) return;
  const file = e.target.files[0]; if(!file) return;
  const fileRef = sRef(storage, `avatars/${curUser.uid}.jpg`);
  await uploadBytes(fileRef, file);
  const url = await getDownloadURL(fileRef);
  await update(ref(db, 'users/'+curUser.uid), { avatar:url });
  profileAvatar.src = url;
  await refreshUsersCache();
  showToast('Аватар обновлён','success');
};
// Смена хештега
hashtagInput.oninput = async (e)=>{
  if(!curUser) return;
  let tag = hashtagInput.value.replace(/[^a-zA-Z0-9#]/g,'').slice(0,4);
  hashtagInput.value = tag;
  await update(ref(db, 'users/'+curUser.uid), { hashtag: tag });
  await refreshUsersCache();
  showToast('Хештег обновлён','success');
};
/* ======================== Events ======================== */
openAuthBtn.onclick = ()=>{ showModal(authModal); };
closeAuth.onclick = ()=> hideModal(authModal);
openProfileBtn.onclick = ()=>{ if(curUser){ showModal(profileModal); } else showToast('Войдите', 'error'); };
closeProfile.onclick = ()=> hideModal(profileModal);
openNewsBtn.onclick = ()=> showModal(newsModal);
closeNews.onclick = ()=> hideModal(newsModal);

openChatBtn.onclick = async ()=>{
  if(!auth.currentUser){ showToast('Войдите для доступа к чатам','error'); return; }
  await refreshUsersCache();
  openChatPanel();
};
$('#closeChatBtn').onclick = ()=> closeChatPanel();
addChatBtn.onclick = async ()=>{ await refreshUsersCache(); openUserPicker(); };
closeUserPicker.onclick = ()=> hideModal(userPickerModal);

chatSend.onclick = sendMessage;
chatInput.addEventListener('keydown', e=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendMessage(); }});

/* ======================== Auth state ======================== */
onAuthStateChanged(auth, async (user)=>{
  curUser = user;
  setAuthUI(!!user);
  if(user){
    // load/ensure user record
    const us = await get(ref(db,'users/'+user.uid));
    if(us.exists()){
      curUserData = us.val();
    }else{
      const role = user.email===ADMIN_EMAIL ? 'admin' : 'user';
      await set(ref(db,'users/'+user.uid), { email:user.email, nickname:user.email.split('@')[0], avatar:'', role });
      curUserData = { email:user.email, nickname:user.email.split('@')[0], avatar:'', role };
    }
    await refreshUsersCache();
    // profile UI
    profileEmail.textContent = user.email;
    profileNickname.textContent = curUserData.nickname || user.email.split('@')[0];
    profileRoleBadge.textContent = ROLE_LABELS[curUserData.role] || 'Пользователь';
    profileAvatar.src = curUserData.avatar || avatarOf(curUserData.nickname);
    hashtagInput.value = curUserData.hashtag || '';
    // nicknameInput больше не нужен тут
    // nicknameInput.value = curUserData.nickname || '';

    // start chat list listener
    listenChatList();
  }else{
    // reset
    chatList.innerHTML = '';
    chatMessages.innerHTML = '';
    peerName.textContent = 'Выберите чат';
    peerAvatar.src = '';
    currentPeerUid = null; currentChatId = null;
    hideModal(chatPanel);
  }
});


/* ======================== Click outside to close some modals ======================== */
window.addEventListener('click', (e)=>{
  if(e.target===authModal) hideModal(authModal);
// Логика переключения вкладок в модалке авторизации
const tabs = document.querySelectorAll('.tab');
const forms = document.querySelectorAll('.form');
const indicator = document.querySelector('.indicator');
tabs.forEach((tab, index) => {
  tab.addEventListener('click', () => {
    tabs.forEach(t => t.classList.remove('active'));
    forms.forEach(f => f.classList.remove('active'));
    tab.classList.add('active');
    document.getElementById(tab.dataset.tab).classList.add('active');
    indicator.style.left = `${index * 50}%`;
  });
});
  if(e.target===newsModal) hideModal(newsModal);
  if(e.target===shortsModal) hideModal(shortsModal);
  if(e.target===userPickerModal) hideModal(userPickerModal);
  if(e.target===chatPanel) hideModal(chatPanel);
});
// Кнопка и функция для удаления чата
deleteChatBtn.onclick = async () => {
  if (!curUser || !currentChatId || !currentPeerUid) return;
  if (!confirm('Удалить чат полностью для обоих пользователей?')) return;
  // Удаляем историю сообщений
  await remove(ref(db, `privateChats/${currentChatId}`));
  // Удаляем чат из индекса у обоих пользователей
  await Promise.all([
    remove(ref(db, `userChats/${curUser.uid}/${currentPeerUid}`)),
    remove(ref(db, `userChats/${currentPeerUid}/${curUser.uid}`))
  ]);
  showToast('Чат удалён', 'success');
  // Сбросить текущий чат
  currentPeerUid = null;
  currentChatId = null;
  chatMessages.innerHTML = '<div style="color:#666;text-align:center;margin-top:16px">Чат удалён.</div>';
  listenChatList();
};
document.addEventListener('DOMContentLoaded', () => {
  const chatHeader = document.querySelector('.chat-header');
  if (chatHeader && !document.getElementById('deleteChatBtn')) {
    deleteChatBtn.id = 'deleteChatBtn';
    chatHeader.appendChild(deleteChatBtn);
  }
});

async function sendMessage(){
  const text = chatInput.value.trim();
  if(!text || !curUser || !currentPeerUid) return;
  const my = usersCache[curUser.uid] || curUserData || {};
  const msgRef = await push(ref(db, `privateChats/${currentChatId}`), {
    uid: curUser.uid,
    email: curUser.email,
    nickname: my.nickname || (curUser.email||'').split('@')[0],
    avatar: my.avatar || '',
    role: my.role || 'user',
    message: text,
    timestamp: Date.now()
  });
  chatInput.value='';
  const peer = usersCache[currentPeerUid] || {};
  const prev = preview(text);
  await Promise.all([
    update(ref(db, `userChats/${curUser.uid}/${currentPeerUid}`), {
      lastTimestamp: Date.now(), lastMessage: prev,
      peerNickname: peer.nickname || '', peerAvatar: peer.avatar || '', peerRole: peer.role || 'user'
    }),
    update(ref(db, `userChats/${currentPeerUid}/${curUser.uid}`), {
      lastTimestamp: Date.now(), lastMessage: prev,
      peerNickname: my.nickname || '', peerAvatar: my.avatar || '', peerRole: my.role || 'user'
    })
  ]);
}
</script>
</body>
</html>
