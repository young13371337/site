<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>young1337</title>
  <link href="https://fonts.googleapis.com/css2?family=Rock+Salt&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#121212;--panel:#181b24;--panel2:#23272e;--ink:#eee;--muted:#aaa;--line:#292c36;
      --brand:#3fa7ff;--ok:#3fcf7f;--err:#e74c3c;--warn:#c2a176;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Ubuntu,'Helvetica Neue',Arial,'Noto Sans',sans-serif;background:var(--bg);color:var(--ink)}

    header{
      position:fixed;inset:0 0 auto 0;height:54px;background:rgba(18,18,18,.9);
      display:flex;align-items:center;gap:16px;padding:0 18px;z-index:1000;box-shadow:0 2px 8px rgba(0,0,0,.7);
    }
    .logo{font-family:'Rock Salt',cursive;font-size:3.2rem;color:#fff;user-select:none;text-shadow:1px 1px 0 #000, 2px 2px 3px rgba(0,0,0,.6);line-height:1.1}
    .header-nav{display:flex;align-items:center;gap:18px}
    .app-button{
      font:700 1.05rem 'Segoe UI',Roboto,sans-serif;color:#fff;background:transparent;border:none;padding:0 16px;border-radius:10px;cursor:pointer;display:flex;align-items:center;justify-content:center;height:36px;transition:all .25s cubic-bezier(.4,2,.3,1)
    }
    .app-button:hover{background:rgba(255,255,255,.12);border:2px solid rgba(255,255,255,.22);box-shadow:0 4px 24px rgba(80,180,255,.18)}
    .hidden{display:none !important}

    .modal{display:none;position:fixed;inset:0;z-index:2000;background:rgba(0,0,0,.7);justify-content:center;align-items:center}
    .modal-content-gray{background:var(--panel2);border-radius:14px;padding:28px 24px;min-width:340px;max-width:500px;color:var(--ink);text-align:center;position:relative}
    .close-btn{position:absolute;right:12px;top:10px;font-size:1.6rem;color:#aaa;background:none;border:none;cursor:pointer;width:38px;height:38px;display:flex;align-items:center;justify-content:center}
    .close-btn:hover{color:#fff;background:rgba(255,255,255,0.08)}
    .input-gray{width:100%;margin-bottom:12px;padding:12px;border-radius:9px;border:1.5px solid #444;background:#2e323a;color:#fff;outline:none}
    .input-gray:focus{border-color:#666;background:#353942}

    /* Chat */
    #chatPanel{display:none;position:fixed;inset:0;z-index:1500;background:rgba(0,0,0,.45);align-items:flex-start;justify-content:center}
    .chat-window{display:flex;gap:0;background:#222;border-radius:12px;max-width:1100px;width:95vw;height:80vh;margin-top:64px;overflow:hidden;position:relative;box-shadow:0 4px 32px rgba(0,0,0,.7)}
    .chat-left{width:280px;min-width:220px;max-height:100%;overflow-y:auto;background:var(--panel);border-right:1px solid var(--line);display:flex;flex-direction:column}
    .chat-left-header{padding:16px 16px 8px 16px;font-weight:700;color:#ddd}
    .chat-add-btn{margin:0 12px 12px 12px;display:flex;align-items:center;gap:8px;padding:10px 12px;border-radius:8px;background:var(--panel2);color:#fff;cursor:pointer;font-weight:700;justify-content:center;border:1px solid transparent}
    .chat-add-btn:hover{border-color:#445}
    .chat-list{display:flex;flex-direction:column;padding:4px 8px 12px 8px;gap:6px}
    .chat-item{display:flex;align-items:center;gap:10px;padding:10px;border-radius:10px;background:transparent;color:#ddd;cursor:pointer;border:1px solid transparent}
    .chat-item:hover{background:#212630;border-color:#2a3344}
    .chat-item.selected{background:#23272e;border-color:#334;box-shadow:inset 0 0 0 1px #334}
    .chat-item-avatar{width:38px;height:38px;border-radius:50%;object-fit:cover;background:#1e1e1e;border:1px solid #333}
    .chat-item-txt{display:flex;flex-direction:column;min-width:0}
    .chat-item-nick{color:var(--brand);font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .chat-item-last{color:#aaa;font-size:.92em;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    .chat-main{flex:1;display:flex;flex-direction:column;min-width:0}
    .chat-header{padding:12px 14px;border-bottom:1px solid var(--line);display:flex;align-items:center;gap:10px;background:#1c1f27}
    .chat-header-title{display:flex;align-items:center;gap:10px;min-width:0}
    .chat-header-right{margin-left:auto;display:flex;gap:8px;align-items:center}
    .chat-peer-avatar{width:40px;height:40px;border-radius:50%;border:1px solid #333;object-fit:cover}
    .chat-peer-avatar.empty{display:none}
    .chat-peer-name{font-weight:800;color:#fff;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:38vw}

    .chat-msgs{flex:1;overflow-y:auto;padding:10px}
    .msg-row{display:flex;align-items:flex-start;gap:10px;padding:6px 8px;border-bottom:1px solid #333}
    .msg-avatar{width:36px;height:36px;border-radius:50%;object-fit:cover;background:#1e1e1e;border:1px solid #333}
    .msg-head{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .msg-nick{color:var(--brand);font-weight:800}
    .chat-role-badge{font-size:.83em;background:#333950;color:#5cb7ff;border-radius:8px;padding:1px 9px;font-weight:700}
    .chat-role-admin{background:#2d1e36;color:#ff7d7d}.chat-role-user{background:#22332d;color:#3fcf7f}
    .msg-time{color:#888;font-size:.9em}
    .msg-text{color:#fff;margin-top:3px;white-space:pre-wrap;word-break:break-word}
    .icon-btn{background:transparent;border:none;color:#bbb;font-size:1.05rem;cursor:pointer;border-radius:6px;padding:4px 6px}
    .icon-btn:hover{background:#2a3344;color:#fff}

    .chat-input-row{display:flex;gap:10px;padding:12px;border-top:1px solid var(--line)}
    #chatInput{flex:1;padding:12px;border-radius:8px;border:1px solid #555;background:#333;color:#eee}

    .toast{position:fixed;left:50%;transform:translateX(-50%);top:22px;z-index:4000;background:#23272e;color:#fff;padding:12px 18px;border-radius:10px;opacity:0;pointer-events:none;transition:opacity .25s, top .25s}
    .toast.show{opacity:1;top:40px}

    /* mobile */
    @media (max-width:600px){
      header{flex-direction:column;align-items:flex-start;height:auto;padding:0 0 8px 0}
      .logo{font-size:2.1rem;margin:8px 0 6px 16px}
      .header-nav{flex-direction:column;align-items:stretch;gap:8px;width:100%;padding:0 12px}
      .app-button{width:100%;text-align:left;padding:10px 12px;font-size:1.05rem;border-radius:8px}

      #chatPanel{align-items:stretch;padding:0}
      .chat-window{flex-direction:column;max-width:100vw;width:100vw;height:100vh;margin-top:0;border-radius:0}
      .chat-left{width:100vw;max-height:30vh;border-right:none;border-bottom:1.5px solid #23272e;overflow-y:auto}
      .chat-main{height:70vh}
      .chat-header{padding:12px 8px 10px 8px}
      .chat-msgs{padding:6px 2vw}
      .chat-input-row{flex-direction:column;gap:7px;padding:8px 2vw 10px 2vw}
    }
    
  </style>
</head>
<body>
<header>
  <div class="logo">young1337</div>
  <nav class="header-nav"
    <!-- Liquid Glass Auth Modal Styles -->
  <style>
    .container {
      background: rgba(32, 36, 48, 0.82);
      backdrop-filter: blur(18px) saturate(120%);
      -webkit-backdrop-filter: blur(18px) saturate(120%);
      border-radius: 18px;
      padding: 44px 36px 36px 36px;
      width: 500px;
      min-height: 340px;
      box-sizing: border-box;
      box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.13), 0 0 0 2px #23272e55;
      color: #e6eaf3;
      position:relative;
      display: flex;
      flex-direction: column;
      justify-content: center;
      border: 1.5px solid #23272e99;
      overflow: hidden;
    }
    .tabs {
      display: flex;
      position: relative;
      margin-bottom: 30px;
      background: rgba(255,255,255,0.08);
      border-radius: 14px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(63,167,255,0.08);
    }
    .tab {
      flex: 1;
      text-align: center;
      padding: 15px 0;
      cursor: pointer;
      font-size: 1.13em;
      color: #b3b9c9;
      transition: color 0.3s, background 0.3s;
      position: relative;
      z-index: 1;
      font-weight: 600;
      letter-spacing: 0.5px;
    }
    .tab.active {
      color: #e6eaf3;
      background: rgba(44,52,70,0.32);
      box-shadow: 0 2px 8px #23272e33;
    }
    .indicator {
      position: absolute;
      height: 100%;
      width: 50%;
      top: 0;
      left: 0;
      background: linear-gradient(90deg, #23272e 0%, #3fa7ff22 100%);
      opacity: 0.13;
      border-radius: 14px;
      box-shadow: 0 2px 8px #23272e22;
      transition: left 0.4s cubic-bezier(.4,2,.6,1);
    }
    .form {
      display: none;
      flex-direction: column;
      gap: 20px;
      opacity: 0;
      transform: translateY(16px) scale(0.98);
      pointer-events: none;
      filter: blur(4px) brightness(0.97);
      transition: opacity 0.45s cubic-bezier(.4,2,.6,1), transform 0.45s cubic-bezier(.4,2,.6,1), filter 0.45s cubic-bezier(.4,2,.6,1);
    }
    .form.active {
      display: flex;
      opacity: 1;
      transform: translateY(0) scale(1);
      pointer-events: auto;
      filter: blur(0) brightness(1);
      transition: opacity 0.45s cubic-bezier(.4,2,.6,1), transform 0.45s cubic-bezier(.4,2,.6,1), filter 0.45s cubic-bezier(.4,2,.6,1);
    }
    #authModal input {
      padding: 15px;
      font-size: 1.1em;
      border-radius: 10px;
      border: 1.5px solid #23272e99;
      background: rgba(44,52,70,0.18);
      color: #e6eaf3;
      outline: none;
      box-shadow: 0 2px 8px #23272e11;
      margin-bottom: 2px;
      transition: border 0.2s, box-shadow 0.2s, background 0.2s;
    }
    #authModal input:focus {
      border: 1.5px solid #3fa7ff;
      box-shadow: 0 0 0 2px #3fa7ff33;
      background: #23272e;
      color: #fff;
    }
    #authModal input::placeholder { color: #7e8ba3; }
    #authModal button {
      padding: 15px;
      font-size: 1.1em;
      border: none;
      border-radius: 10px;
      background: #23272e;
      color: #e6eaf3;
      font-weight: bold;
      cursor: pointer;
      position: relative;
      overflow: hidden;
      box-shadow: 0 4px 20px #23272e22, 0 2px 8px #23272e11;
      transition: transform 0.2s, box-shadow 0.3s, background 0.3s;
      margin-top: 8px;
      letter-spacing: 0.5px;
    }
    #authModal button::before {
      content: "";
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle at center, rgba(63,167,255,0.08) 0%, transparent 70%);
      opacity: 0.13;
      transform: translate(-50%, -50%) rotate(0deg);
      transition: transform 0.5s;
    }
    #authModal button:hover::before { transform: translate(-50%, -50%) rotate(25deg); }
    #authModal button:hover {
      transform: scale(1.04);
      background: #23272e;
      box-shadow: 0 6px 25px #23272e22, 0 2px 8px #3fa7ff11;
    }
     </style>
    <button class="app-button" id="openProfile" style="display:none;">Профиль</button>
    <button class="app-button" id="openAuth">Авторизация</button>
    <button class="app-button" id="openChat">Чаты</button>
    <button class="app-button" id="openNews">Новости</button>
  </nav>
</header>

<main style="padding-top:80px;text-align:center">
  <h1 style="font-weight:800;margin:24px 0 8px">Добро пожаловать</h1>
  <p style="color:#aaa;margin:0">Информация об обновлении тут - @young1337dev</p>
</main>

<!-- AUTH MODAL -->
<div id="authModal" class="modal" style="z-index:3000;">
  <div class="modal-content-gray" style="max-width:520px">
    <button class="close-btn" id="closeAuth">×</button>
    <h2>Вход</h2>
    <form id="login" style="margin-bottom:18px">
      <input type="email" id="loginEmail" class="input-gray" placeholder="Email" required>
      <input type="password" id="loginPassword" class="input-gray" placeholder="Пароль" required>
      <button type="submit" class="app-button" style="width:100%;background:#23272e">Войти</button>
    </form>
    <h2 style="margin-top:8px">Регистрация</h2>
    <form id="register">
      <input type="email" id="registerEmail" class="input-gray" placeholder="Email" required>
      <input type="password" id="registerPassword" class="input-gray" placeholder="Пароль" required>
      <label style="display:flex;align-items:center;gap:8px;justify-content:center;color:#aaa;font-size:.95em;margin-top:2px">
        <input type="checkbox" id="registerPolicy" required style="accent-color:#3fa7ff"> Я принимаю условия
      </label>
      <button type="submit" class="app-button" style="width:100%;background:#23272e">Зарегистрироваться</button>
    </form>
  </div>
</div>

<!-- PROFILE -->
<div id="profileModal" class="modal">
  <div class="modal-content-gray" style="max-width:480px">
    <button class="close-btn" id="closeProfile">×</button>
    <img id="profileAvatar" class="profile-avatar" src="" alt="avatar" style="width:84px;height:84px;border-radius:50%;border:2px solid var(--brand);display:block;margin:6px auto 10px;object-fit:cover;background:#1e1e1e">
    <div style="margin:8px 0">
      <span id="profileNickname" style="font-weight:800"></span>
      <button id="editNickBtn" class="icon-btn" title="Сменить ник">✏️</button>
      <span id="profileRoleBadge" class="chat-role-badge chat-role-user">Пользователь</span>
    </div>
    <div style="margin:6px 0">Почта: <span id="profileEmail"></span></div>
    <div style="display:flex;gap:0;margin:10px 0">
      <input id="newPasswordInput" class="input-gray" type="password" placeholder="Новый пароль" style="flex:1;border-top-right-radius:0;border-bottom-right-radius:0;margin:0;border-right:none">
      <button id="changePasswordBtn" class="app-button" style="border-top-left-radius:0;border-bottom-left-radius:0;background:#23272e">Сменить пароль</button>
    </div>
    <button id="logoutBtn" class="app-button" style="width:100%;background:#e74c3c">Выйти</button>
  </div>
</div>

<!-- CHAT PANEL -->
<div id="chatPanel" class="modal" style="background:rgba(0,0,0,.45)">
  <div class="chat-window">
    <button id="closeChatBtn" class="close-btn" title="Закрыть" style="z-index:10">×</button>
    <aside class="chat-left">
      <div class="chat-left-header">Чаты</div>
      <button id="addChatBtn" class="chat-add-btn">+ Новый чат</button>
      <div id="chatList" class="chat-list"></div>
    </aside>
    <section class="chat-main">
      <div class="chat-header" id="chatHeader">
        <div class="chat-header-title">
          <img id="peerAvatar" class="chat-peer-avatar empty" src="" alt="">
          <div class="chat-peer-name" id="peerName">Выберите чат</div>
        </div>
        <!-- Кнопки «звонок/очистка» справа -->
        <div class="chat-header-right">
          <button id="callBtnHeader" class="icon-btn" title="Позвонить" disabled>📞</button>
          <button id="clearChatBtn" class="icon-btn" title="Очистить чат" disabled>🧹</button>
            <button id="clearChatBtn" class="icon-btn" title="Очистить чат" disabled></button>
              <button id="clearChatBtn" class="icon-btn" title="Очистить чат" disabled></button>
        </div>
      </div>
      <div id="chatMessages" class="chat-msgs"></div>
      <div class="chat-input-row">
        <input id="chatInput" type="text" placeholder="Ваше сообщение...">
        <button id="chatSend" class="app-button">Отправить</button>
      </div>
    </section>
  </div>
</div>

<!-- USER PICKER -->
<div id="userPickerModal" class="modal">
  <div class="modal-content-gray" style="max-width:520px">
    <button class="close-btn" id="closeUserPicker">×</button>
    <h2>Начать новый чат</h2>
    <input id="userSearch" class="input-gray" placeholder="Поиск по нику или email">
    <div id="userPickerList" style="max-height:420px;overflow:auto;border-top:1px solid #333;margin-top:10px;padding-top:8px"></div>
  </div>
</div>

<!-- NEWS (заглушка) -->
<div id="newsModal" class="modal">
  <div class="modal-content-gray">
    <button class="close-btn" id="closeNews">×</button>
    <h2>Новости</h2>
    <ul style="text-align:left">
      <li>2.2 Update</li>
    </ul>
  </div>
</div>

<!-- CALL MODAL -->
<div id="callModal" class="modal" style="z-index:4000;">
  <div class="modal-content-gray" style="max-width:360px;text-align:center">
    <button class="close-btn" id="closeCallModal" title="Скрыть">×</button>
    <div id="callStatus" style="font-size:1.15em;margin:4px 0 10px"></div>
    <div id="callPeer" style="font-weight:700;margin-bottom:16px;"></div>
    <div id="callActions" style="display:flex;gap:10px;justify-content:center;"></div>
    <audio id="remoteAudio" autoplay playsinline style="width:100%;margin-top:14px;"></audio>
  </div>
</div>

<!-- TOAST -->
<div id="toast" class="toast"></div>

<script type="module">
/* ================= Firebase ================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updatePassword } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
import { getDatabase, ref, get, set, update } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";
import { getFirestore, collection, query, orderBy, onSnapshot, addDoc, setDoc, doc, getDocs, updateDoc, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";
import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-storage.js";

/* === config (твой же) === */
const firebaseConfig = {
  apiKey: "AIzaSyDjTaleNo3RlfJECEEm24UGg4sx6AFvp7E",
  authDomain: "young1337-c6a15.firebaseapp.com",
  databaseURL: "https://young1337-c6a15-default-rtdb.firebaseio.com",
  projectId: "young1337-c6a15",
  storageBucket: "young1337-c6a15.appspot.com",
  messagingSenderId: "349710701737",
  appId: "1:349710701737:web:c9f5e5e86d0b29dc6b05b8",
  measurementId: "G-DXVL8D5L44"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const rtdb = getDatabase(app);
const fsdb = getFirestore(app);
const storage = getStorage(app);

/* ================= Utils ================= */
const ADMIN_EMAIL = "timurnazaev001@gmail.com";
const ROLE_LABELS = { admin:"Разработчик", user:"Пользователь" };
const ROLE_CLASS  = { admin:"chat-role-badge chat-role-admin", user:"chat-role-badge chat-role-user" };
const $  = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);
const toast = $('#toast');

function showToast(msg, type='info'){
  toast.textContent = msg;
  toast.style.background = type==='error' ? '#2e2323' : '#23272e';
  toast.style.color = type==='error' ? '#f66' : (type==='success' ? '#3fcf7f' : '#fff');
  toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'), 2200);
}
function escapeHtml(s){ return (s??'').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;') }
function fmtTime(ts){ const d=new Date(ts); return d.toLocaleString('ru-RU',{hour:'2-digit',minute:'2-digit',day:'2-digit',month:'2-digit'}) }
function avatarOf(nick){ return "https://ui-avatars.com/api/?name="+encodeURIComponent(nick||'?')+"&background=323a47&color=3fa7ff" }
function chatIdOf(a,b){ return [a,b].sort().join('_') }
function preview(text, n=40){ if(!text) return ""; const t=text.replace(/\s+/g,' ').trim(); return t.length>n? t.slice(0,n-1)+'…':t }

/* ================= DOM refs ================= */
const openProfileBtn = $('#openProfile');
const openAuthBtn    = $('#openAuth');
const openChatBtn    = $('#openChat');
const openNewsBtn    = $('#openNews');


const authModal = $('#authModal'); const closeAuth = $('#closeAuth');
const profileModal = $('#profileModal'); const closeProfile = $('#closeProfile');

const userPickerModal = $('#userPickerModal'); const closeUserPicker = $('#closeUserPicker');
const userSearch = $('#userSearch'); const userPickerList = $('#userPickerList');

const chatPanel = $('#chatPanel'); const chatList = $('#chatList');
const addChatBtn = $('#addChatBtn'); const chatMessages = $('#chatMessages');
const chatInput = $('#chatInput'); const chatSend = $('#chatSend');
const peerName = $('#peerName'); const peerAvatar = $('#peerAvatar');
const callBtnHeader = $('#callBtnHeader'); const clearChatBtn = $('#clearChatBtn');

const profileEmail = $('#profileEmail'); const profileNickname = $('#profileNickname');
const profileRoleBadge = $('#profileRoleBadge'); const profileAvatar = $('#profileAvatar');
const editNickBtn = $('#editNickBtn');
const newPasswordInput = $('#newPasswordInput'); const changePasswordBtn = $('#changePasswordBtn');

/* ================= State ================= */
let curUser = null;
let curUserData = {nickname:"", avatar:"", role:"user", email:""};
let usersCache = {};     // uid -> {nickname, avatar, email, role}
let chatUnsub = null;
let currentPeerUid = null;
let currentChatId = null;

/* ================= UI helpers ================= */
const showModal = el => el.style.display='flex';
const hideModal = el => el.style.display='none';

function setAuthUI(authenticated){
  if(authenticated){ openProfileBtn.style.display=''; openAuthBtn.style.display='none'; }
  else { openProfileBtn.style.display='none'; openAuthBtn.style.display=''; }
}
function getRoleBadge(role){
  const cls = ROLE_CLASS[role] || ROLE_CLASS.user;
  const title = ROLE_LABELS[role] || ROLE_LABELS.user;
  return `<span class="${cls}">${title}</span>`;
}

/* ================= Auth ================= */
$('#register').addEventListener('submit', async e=>{
  e.preventDefault();
  const email = $('#registerEmail').value.trim();
  const pass  = $('#registerPassword').value.trim();
  if(!email || !pass) return showToast('Заполните все поля','error');
  try{
    const cred = await createUserWithEmailAndPassword(auth, email, pass);
    const nick = email.split('@')[0];
    const role = email===ADMIN_EMAIL ? 'admin' : 'user';
    await set(ref(rtdb, 'users/'+cred.user.uid), { email, nickname:nick, avatar:'', role });
    showToast('Успешная регистрация','success');
    hideModal(authModal);
  }catch(err){ showToast('Ошибка: '+(err.message||err),'error'); }
});
$('#login').addEventListener('submit', async e=>{
  e.preventDefault();
  const email = $('#loginEmail').value.trim();
  const pass  = $('#loginPassword').value.trim();
  if(!email || !pass) return showToast('Заполните все поля','error');
  try{
    await signInWithEmailAndPassword(auth, email, pass);
    showToast('Вход выполнен','success');
    hideModal(authModal);
  }catch(err){ showToast('Ошибка: '+(err.message||err),'error'); }
});
$('#logoutBtn').onclick = ()=>signOut(auth);

editNickBtn.onclick = ()=>{
  const nn = prompt('Новый ник', profileNickname.textContent || '');
  if(nn && curUser){
    update(ref(rtdb,'users/'+curUser.uid),{nickname:nn}).then(async ()=>{
      profileNickname.textContent = nn;
      await refreshUsersCache();
      showToast('Ник обновлён','success');
    });
  }
};
changePasswordBtn.onclick = async ()=>{
  if(!curUser) return;
  const p = newPasswordInput.value.trim();
  if(!p) return showToast('Введите новый пароль','error');
  try{ await updatePassword(curUser, p); newPasswordInput.value=''; showToast('Пароль изменён','success'); }
  catch(err){ showToast('Ошибка: '+(err.message||err),'error'); }
};

openAuthBtn.onclick = ()=>showModal(authModal);
closeAuth.onclick   = ()=>hideModal(authModal);
openProfileBtn.onclick = ()=>{ if(!curUser) return; showModal(profileModal); };
closeProfile.onclick = ()=>hideModal(profileModal);

/* ================= Users cache & picker ================= */
async function refreshUsersCache(){
  const snap = await get(ref(rtdb,'users'));
  usersCache = snap.exists()? snap.val() : {};
}
function openUserPicker(){
  $('#userSearch').value = '';
  renderUserPicker('');
  showModal(userPickerModal);
}
function renderUserPicker(filter){
  const f = (filter||'').toLowerCase();
  userPickerList.innerHTML='';
  Object.entries(usersCache).forEach(([uid,u])=>{
    if(!curUser || uid===curUser.uid) return;
    const needle = (u.nickname||'')+' '+(u.email||'');
    if(f && !needle.toLowerCase().includes(f)) return;
    const av = u.avatar || avatarOf(u.nickname);
    const el = document.createElement('div');
    el.className='userpick-item';
    el.style.cssText='display:flex;align-items:center;gap:10px;padding:8px;border-radius:8px;cursor:pointer';
    el.innerHTML = `<img src="${av}" style="width:36px;height:36px;border-radius:50%;object-fit:cover;border:1px solid #333">
                    <div><div style="font-weight:800">${escapeHtml(u.nickname||'?')}</div><div style="color:#aaa;font-size:.92em">${escapeHtml(u.email||'')}</div></div>`;
    el.onclick=()=>{ hideModal(userPickerModal); openChatWith(uid); };
    userPickerList.appendChild(el);
  });
}
userSearch.addEventListener('input', e=>renderUserPicker(e.target.value));
addChatBtn.onclick = openUserPicker;
closeUserPicker.onclick=()=>hideModal(userPickerModal);

/* ================= Chat (Firestore) ================= */
function listenChatList(){
  if(!curUser) return;
  const userChatsRef = collection(fsdb, "userChats", curUser.uid, "peers");
  const qy = query(userChatsRef, orderBy("lastTimestamp","desc"));
  onSnapshot(qy, snap=>{
    const arr = snap.docs.map(d=>({ peerUid:d.id, ...d.data() }));
    renderChatList(arr);
  });
}
function renderChatList(items){
  chatList.innerHTML='';
  items.forEach(item=>{
    const u = usersCache[item.peerUid] || {};
    const avatar = (item.peerAvatar || u.avatar || avatarOf(u.nickname));
    const selected = item.peerUid === currentPeerUid ? 'selected' : '';
    const li = document.createElement('div');
    li.className = `chat-item ${selected}`;
    li.dataset.uid = item.peerUid;
    li.innerHTML = `
      <img class="chat-item-avatar" src="${avatar}" alt="">
      <div class="chat-item-txt">
        <div class="chat-item-nick">${escapeHtml(u.nickname || '???')}</div>
        <div class="chat-item-last">${escapeHtml(item.lastMessage || '')}</div>
      </div>
    `;
    li.onclick = ()=>openChatWith(item.peerUid);
    chatList.appendChild(li);
  });
}
function renderChatHeader(peer){
  const hasPeer = !!peer && !!peer.nickname;
  if (peer && peer.avatar) {
    peerAvatar.src = peer.avatar; peerAvatar.classList.remove('empty');
  } else { peerAvatar.src = ''; peerAvatar.classList.add('empty'); }
  peerName.textContent = hasPeer ? (peer.nickname || 'Пользователь') : 'Выберите чат';
  callBtnHeader.disabled  = !hasPeer;
  clearChatBtn.disabled   = !hasPeer;
}

async function openChatWith(peerUid){
  if(!curUser) { showToast('Войдите для доступа к чату','error'); return; }
  if(chatUnsub){ chatUnsub(); chatUnsub=null; }
  currentPeerUid = peerUid;
  currentChatId = chatIdOf(curUser.uid, peerUid);

  const my   = usersCache[curUser.uid] || curUserData || {};
  const peer = usersCache[peerUid]     || {};
  renderChatHeader(peer);

  // создать записи в userChats (оба)
  const ts = Date.now();
  await Promise.all([
    setDoc(doc(fsdb,"userChats",curUser.uid,"peers",peerUid), {
      lastTimestamp: ts, lastMessage: '',
      peerNickname: peer.nickname||'', peerAvatar: peer.avatar||'', peerRole: peer.role||'user', created:true
    }, {merge:true}),
    setDoc(doc(fsdb,"userChats",peerUid,"peers",curUser.uid), {
      lastTimestamp: ts, lastMessage: '',
      peerNickname: my.nickname||'', peerAvatar: my.avatar||'', peerRole: my.role||'user', created:true
    }, {merge:true})
  ]);

  // слушать сообщения
  const messagesRef = collection(fsdb,"chats",currentChatId,"messages");
  const qy = query(messagesRef, orderBy("timestamp","asc"));
  chatUnsub = onSnapshot(qy, snap=>{
    const msgs = snap.docs.map(d=>({id:d.id, ...d.data()}));
    renderMessages(msgs);
  });

  // кнопки шапки
  callBtnHeader.onclick = ()=> startCallWithUser(peerUid, peer.nickname || '???');
  clearChatBtn.onclick = ()=> clearCurrentChat();
}

function renderMessages(messages){
  chatMessages.innerHTML='';
  if(messages.length===0){
    chatMessages.innerHTML = '<div style="color:#666;text-align:center;margin-top:16px">Сообщений пока нет. Напишите первым!</div>';
    return;
  }
  messages.forEach(m=>renderMessage(m));
  chatMessages.scrollTop = chatMessages.scrollHeight;
}
function renderMessage(m){
  const mine = curUser && m.uid===curUser.uid;
  const u = usersCache[m.uid]||{};
  const nickname = m.nickname || u.nickname || '???';
  const avatar = m.avatar || u.avatar || avatarOf(nickname);
  const role = m.role || u.role || 'user';

  const row = document.createElement('div');
  row.className='msg-row';
  row.innerHTML = `
    <img class="msg-avatar" src="${avatar}" alt="">
    <div style="flex:1;min-width:0">
      <div class="msg-head">
        <span class="msg-nick">${escapeHtml(nickname)}</span>
        ${getRoleBadge(role)}
        <span class="msg-time">${fmtTime(m.timestamp||Date.now())}</span>
        ${mine ? `<button class="icon-btn" data-id="${m.id}" title="Редактировать">✏️</button>` : ''}
      </div>
      <div class="msg-body"><span class="msg-text">${escapeHtml(m.message||'')}</span></div>
    </div>
  `;
  chatMessages.appendChild(row);

  if(mine){
    row.querySelector('.icon-btn').onclick = async ()=>{
      const newText = prompt('Изменить сообщение', m.message||'');
      if(!newText || !currentChatId) return;
      await updateDoc(doc(fsdb,"chats",currentChatId,"messages",m.id), { message:newText.trim(), edited:true });
    };
  }
}

/* send message */
async function sendMessage(){
  const text = chatInput.value.trim();
  if(!text || !curUser || !currentPeerUid) return;
  const my = usersCache[curUser.uid] || curUserData || {};
  const ts = Date.now();
  chatInput.value=''; chatInput.focus();

  await addDoc(collection(fsdb,"chats",currentChatId,"messages"),{
    uid:curUser.uid, email:curUser.email, nickname: my.nickname || (curUser.email||'').split('@')[0],
    avatar: my.avatar || '', role: my.role || 'user', message:text, timestamp:ts
  });
  const peer = usersCache[currentPeerUid] || {};
  const prev = preview(text);
  await Promise.all([
    setDoc(doc(fsdb,"userChats",curUser.uid,"peers",currentPeerUid), {
      lastTimestamp: ts, lastMessage: prev, peerNickname: peer.nickname||'', peerAvatar: peer.avatar||'', peerRole: peer.role||'user', created:true
    },{merge:true}),
    setDoc(doc(fsdb,"userChats",currentPeerUid,"peers",curUser.uid), {
      lastTimestamp: ts, lastMessage: prev, peerNickname: my.nickname||'',  peerAvatar: my.avatar||'',  peerRole: my.role||'user', created:true
    },{merge:true})
  ]);
}
chatSend.onclick = sendMessage;
chatInput.addEventListener('keydown', e=>{ if(e.key==='Enter') sendMessage(); });

async function clearCurrentChat(){
  if(!currentChatId) return;
  if(!confirm('Очистить все сообщения в этом чате?')) return;
  const msgsRef = collection(fsdb,"chats",currentChatId,"messages");
  const snap = await getDocs(msgsRef);
  const batch = writeBatch(fsdb);
  snap.docs.forEach(d=>batch.delete(d.ref));
  await batch.commit();
  showToast('Чат очищен','success');
}

/* open/close chat panel */
$('#openChat').onclick = ()=>{ showModal(chatPanel); setTimeout(()=>chatInput.focus(),50); };
$('#closeChatBtn').onclick = ()=> hideModal(chatPanel);

/* ================= Calls (WebRTC + Firestore signaling) ================= */
const CALLS_COLLECTION = 'calls';
let callPeerUid = null;
let callPeerNick = '';
let pc = null;
let localStream = null;
let callDocRef = null;
let unsubCallDoc = null;
let unsubCallerCandidates = null;
let unsubCalleeCandidates = null;
let isCaller = false;
let isMuted = false;

function createPeerConnection(){
  const rtc = new RTCPeerConnection({ iceServers:[{urls:'stun:stun.l.google.com:19302'}] });
  rtc.ontrack = e=>{ $('#remoteAudio').srcObject = e.streams[0]; };
  return rtc;
}
function showCallModal(status, nick, actions=[]){
  $('#callStatus').textContent = status;
  $('#callPeer').textContent = nick||'';
  const area = $('#callActions'); area.innerHTML='';
  actions.forEach(b=>area.appendChild(b));
  showModal($('#callModal'));
}
function hideCallModal(){ hideModal($('#callModal')); }

async function startCallWithUser(peerUid, peerNick){
  if(!curUser) return showToast('Войдите','error');
  callPeerUid = peerUid; callPeerNick = peerNick; isCaller = true; isMuted=false;

  const btnMute   = document.createElement('button'); btnMute.className='app-button'; btnMute.textContent='🔇 Mute';
  const btnHangup = document.createElement('button'); btnHangup.className='app-button'; btnHangup.textContent='❌ Завершить';
  btnMute.onclick = toggleMute; btnHangup.onclick = endCall;
  showCallModal('Звоним...', peerNick, [btnMute, btnHangup]);

  try{
    pc = createPeerConnection();
    localStream = await navigator.mediaDevices.getUserMedia({audio:true});
    localStream.getTracks().forEach(t=>pc.addTrack(t, localStream));

    // создать call doc
    callDocRef = await addDoc(collection(fsdb, CALLS_COLLECTION),{
      callerUid: curUser.uid, callerNick: curUserData.nickname || curUser.email,
      calleeUid: peerUid, status:'offer', created: Date.now()
    });

    // подколлекции кандидатов
    const callerCandidatesCol = collection(fsdb, CALLS_COLLECTION, callDocRef.id, 'callerCandidates');
    const calleeCandidatesCol = collection(fsdb, CALLS_COLLECTION, callDocRef.id, 'calleeCandidates');

    pc.onicecandidate = e=>{ if(e.candidate) addDoc(callerCandidatesCol, {candidate: e.candidate.toJSON()}); };

    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    await setDoc(callDocRef, { offer: JSON.stringify(offer) }, {merge:true});

    // слушать answer и входящие кандидаты callee
    unsubCallDoc = onSnapshot(callDocRef, async snap=>{
      const data = snap.data();
      if(data?.answer && !pc.currentRemoteDescription){
        await pc.setRemoteDescription(JSON.parse(data.answer));
        showCallModal('Вызов...', peerNick, [btnMute, btnHangup]);
      }
      if(data?.status==='end') await endCall();
    });
    unsubCalleeCandidates = onSnapshot(calleeCandidatesCol, (snap)=>{
      snap.docChanges().forEach(async change=>{
        if(change.type==='added'){
          try{ await pc.addIceCandidate(change.doc.data().candidate); }catch(_){}
        }
      });
    });
  }catch(err){
    showToast('Ошибка WebRTC: '+(err.message||err),'error');
    await endCall();
  }
}

/* входящие */
function listenIncomingCalls(){
  if(!curUser) return;
  onSnapshot(collection(fsdb, CALLS_COLLECTION), (snap)=>{
    snap.docChanges().forEach(change=>{
      const d = change.doc.data();
      if(d.calleeUid===curUser.uid && d.status==='offer' && d.offer){
        onIncomingCall(change.doc.id, d);
      }
    });
  });
}
function onIncomingCall(callId, data){
  callPeerUid = data.callerUid; callPeerNick = data.callerNick || '???'; isCaller = false; isMuted=false;

  const btnAccept = document.createElement('button'); btnAccept.className='app-button'; btnAccept.textContent='✅ Принять';
  const btnReject = document.createElement('button'); btnReject.className='app-button'; btnReject.textContent='❌ Отклонить';
  btnAccept.onclick = ()=>acceptCall(callId, data);
  btnReject.onclick = ()=>rejectCall(callId);
  showCallModal('Входящий звонок...', callPeerNick, [btnAccept, btnReject]);
}
async function acceptCall(callId, data){
  const btnMute   = document.createElement('button'); btnMute.className='app-button'; btnMute.textContent='🔇 Mute';
  const btnHangup = document.createElement('button'); btnHangup.className='app-button'; btnHangup.textContent='❌ Завершить';
  btnMute.onclick = toggleMute; btnHangup.onclick = endCall;
  showCallModal('Вызов...', callPeerNick, [btnMute, btnHangup]);

  pc = createPeerConnection();
  localStream = await navigator.mediaDevices.getUserMedia({audio:true});
  localStream.getTracks().forEach(t=>pc.addTrack(t, localStream));

  callDocRef = doc(fsdb, CALLS_COLLECTION, callId);
  const callerCandidatesCol = collection(fsdb, CALLS_COLLECTION, callId, 'callerCandidates');
  const calleeCandidatesCol = collection(fsdb, CALLS_COLLECTION, callId, 'calleeCandidates');

  pc.onicecandidate = e=>{ if(e.candidate) addDoc(calleeCandidatesCol, {candidate: e.candidate.toJSON()}); };

  const offer = JSON.parse(data.offer);
  await pc.setRemoteDescription(offer);
  const answer = await pc.createAnswer();
  await pc.setLocalDescription(answer);
  await setDoc(callDocRef, { answer: JSON.stringify(answer), status:'answer' }, {merge:true});

  unsubCallDoc = onSnapshot(callDocRef, async snap=>{
    const dd = snap.data();
    if(dd?.status==='end') await endCall();
  });
  unsubCallerCandidates = onSnapshot(callerCandidatesCol, (snap)=>{
    snap.docChanges().forEach(async change=>{
      if(change.type==='added'){
        try{ await pc.addIceCandidate(change.doc.data().candidate); }catch(_){}
      }
    });
  });
}
async function rejectCall(callId){
  await setDoc(doc(fsdb,CALLS_COLLECTION,callId), {status:'end'}, {merge:true});
  await endCall();
}

function toggleMute(){
  if(!localStream) return;
  isMuted = !isMuted;
  localStream.getAudioTracks().forEach(t=>t.enabled = !isMuted);
  // обновим подпись кнопки
  const btn = Array.from($('#callActions').children).find(b=>b.textContent.includes('Mute')||b.textContent.includes('Unmute'));
  if(btn) btn.textContent = isMuted ? '🔈 Unmute' : '🔇 Mute';
}
async function endCall(){
  hideCallModal();
  try{
    if(unsubCallDoc){unsubCallDoc();unsubCallDoc=null;}
    if(unsubCallerCandidates){unsubCallerCandidates();unsubCallerCandidates=null;}
    if(unsubCalleeCandidates){unsubCalleeCandidates();unsubCalleeCandidates=null;}
    if(pc){ pc.close(); pc=null; }
    if(localStream){ localStream.getTracks().forEach(t=>t.stop()); localStream=null; }
    $('#remoteAudio').srcObject = null;

    if(callDocRef){
      await setDoc(callDocRef, {status:'end'}, {merge:true});
      // опционально: подчистить кандидатов
      // удалять документ целиком не будем — истории пригодятся
    }
  }catch(_){}
  callPeerUid = null; callPeerNick=''; isCaller=false; isMuted=false;
}
$('#closeCallModal').onclick = hideCallModal;

/* ================= App wiring ================= */
async function bootstrap(){
  setAuthUI(false);
  onAuthStateChanged(auth, async (user)=>{
    curUser = user || null;
    if(user){
      setAuthUI(true);
      profileEmail.textContent = user.email;
      const snap = await get(ref(rtdb,'users/'+user.uid));
      const u = snap.exists()? snap.val() : {};
      curUserData = {nickname:u.nickname||user.email.split('@')[0], avatar:u.avatar||'', role:u.role||'user', email:user.email};
      profileNickname.textContent = curUserData.nickname;
      profileRoleBadge.textContent = ROLE_LABELS[curUserData.role] || 'Пользователь';
      profileRoleBadge.className = ROLE_CLASS[curUserData.role] || ROLE_CLASS.user;
      profileAvatar.src = curUserData.avatar || avatarOf(curUserData.nickname);

      await refreshUsersCache();
      listenChatList();
      listenIncomingCalls();
    }else{
      curUserData = {nickname:"", avatar:"", role:"user", email:""};
      usersCache = {};
      chatList.innerHTML='';
      chatMessages.innerHTML='';
    }
  });

  openNewsBtn.onclick = ()=>showModal($('#newsModal'));
  $('#closeNews').onclick = ()=>hideModal($('#newsModal'));
}
bootstrap();
</script>
</body>
</html>
